<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>会津若松市 勤務実績管理システム</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SheetJS (Excel Export) -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <!-- Phosphor Icons (for icons) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f3f4f6;
            -webkit-text-size-adjust: 100%;
        }

        /* 画面表示用ユーティリティ */
        .screen-only {
            display: block;
        }

        /* 印刷レイアウトは通常時非表示 */
        .print-only {
            display: none;
        }

        /* 印刷時のスタイル */
        @media print {
            @page {
                size: A4 portrait;
                margin: 10mm; /* 余白を確保 */
            }
            body {
                background-color: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                width: 100%;
                margin: 0;
                padding: 0;
                font-size: 10pt; /* 基本フォントサイズ */
            }
            
            .screen-only, .no-print, #root > div > div.screen-only {
                display: none !important;
            }

            /* 印刷コンテナを表示 */
            .print-only {
                display: block !important;
                position: relative; 
                width: 100%;
                max-width: 100%; 
                margin: 0 auto;   /* センタリング */
                visibility: visible;
                overflow: visible;
            }
            .print-only * {
                visibility: visible;
            }

            /* タイトル周り */
            .print-title {
                text-align: center;
                margin-bottom: 2mm; /* 余白を詰める */
            }
            .print-title h2 {
                font-size: 14pt;
                font-weight: bold;
                border-bottom: 1px solid #000;
                display: inline-block;
                padding-bottom: 1mm;
                margin: 0;
            }

            /* テーブルのスタイルと罫線強制 */
            table.print-table {
                width: 100%;
                border-collapse: collapse;
                border: 2px solid #000 !important; /* 外枠を黒く太く */
                font-size: 8pt; /* フォントサイズを少し小さくして収める */
                table-layout: fixed;
                margin-bottom: 1mm;
            }
            table.print-table th, table.print-table td {
                border: 1px solid #000 !important; /* 黒色罫線を強制 */
                padding: 0 2px; /* 上下のパディングを極力減らす */
                height: 1.4em; /* 行の高さを固定してページ内収まりを良くする */
                vertical-align: middle;
                overflow: hidden;
                white-space: nowrap;
                color: #000 !important; /* 文字色も黒強制 */
            }
            
            /* ヘッダーセルのスタイル */
            table.print-table th {
                background-color: #f0f0f0 !important;
                font-weight: bold;
                text-align: center;
                height: 1.6em;
            }

            /* フッター情報のスタイル */
            .print-footer {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                font-size: 8pt;
                margin-top: 1mm;
            }
            .print-footer-box {
                border: 1px solid #000;
                padding: 1mm 2mm; /* パディング調整 */
                width: 35%;
            }
            .print-footer-info {
                border: 1px solid #ccc;
                padding: 1mm 2mm;
                width: 60%;
                line-height: 1.2;
            }
            
            /* 入力要素のリセット */
            input, select {
                border: none;
                background: transparent;
                width: 100%;
                font-family: inherit;
                font-size: inherit;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
                padding: 0;
                margin: 0;
                text-align: center;
                line-height: 1;
                color: #000 !important;
                height: 100%;
                display: block;
            }
            input[type="text"] {
                text-align: left;
                padding-left: 1mm;
            }
            select::-ms-expand { display: none; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 定数・設定 ---
        const STATUS_OPTIONS = [
            { value: 'work', label: '出勤' },
            { value: 'off_assigned', label: '週休日' },
            { value: 'holiday', label: '祝日' },
            { value: 'paid_leave', label: '年休' },
            { value: 'special_leave', label: '特別休暇' },
            { value: 'substitute', label: '振替休日' },
            { value: 'absent', label: '欠勤' },
        ];

        const WEEKDAYS = ['日', '月', '火', '水', '木', '金', '土'];

        // 簡易祝日データ
        const HOLIDAYS_DATA = {
            '2025-01-01': '元日', '2025-01-13': '成人の日', '2025-02-11': '建国記念の日',
            '2025-02-23': '天皇誕生日', '2025-02-24': '振替休日', '2025-03-20': '春分の日',
            '2025-04-29': '昭和の日', '2025-05-03': '憲法記念日', '2025-05-04': 'みどりの日',
            '2025-05-05': 'こどもの日', '2025-05-06': '振替休日', '2025-07-21': '海の日',
            '2025-08-11': '山の日', '2025-09-15': '敬老の日', '2025-09-23': '秋分の日',
            '2025-10-13': 'スポーツの日', '2025-11-03': '文化の日', '2025-11-23': '勤労感謝の日',
            '2025-11-24': '振替休日',
            '2026-01-01': '元日', '2026-01-12': '成人の日', '2026-02-11': '建国記念の日',
            '2026-02-23': '天皇誕生日'
        };

        const STORAGE_KEY = 'aizu_kintai_v1';
        const WORK_START_HM = "08:30";
        const WORK_END_HM = "17:15";

        const TIME_OPTIONS = [];
        for (let h = 0; h < 24; h++) {
            for (let m = 0; m < 60; m += 15) {
                const hh = String(h).padStart(2, '0');
                const mm = String(m).padStart(2, '0');
                TIME_OPTIONS.push(`${hh}:${mm}`);
            }
        }

        const LEAVE_TIME_OPTIONS = TIME_OPTIONS.filter(t => {
            return t >= WORK_START_HM && t <= WORK_END_HM;
        });

        // --- ユーティリティ ---
        const timeToMinutes = (timeStr) => {
            if (!timeStr) return 0;
            const [h, m] = timeStr.split(':').map(Number);
            return h * 60 + m;
        };

        const minutesToTime = (mins) => {
            if (mins <= 0) return '';
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            return `${h}:${m.toString().padStart(2, '0')}`;
        };

        // --- コンポーネント ---

        const TimeSelect = ({ value, onChange, disabled, options = TIME_OPTIONS, className = "" }) => (
            <select 
                className={`outline-none bg-transparent w-full ${disabled ? 'text-gray-300' : ''} ${className}`}
                value={value || ''}
                onChange={onChange}
                disabled={disabled}
            >
                <option value="">-</option>
                {options.map(t => <option key={t} value={t}>{t}</option>)}
            </select>
        );

        // ユーザー編集モーダル
        const UserEditModal = ({ isOpen, onClose, userName, onRename, onDelete }) => {
            const [editName, setEditName] = useState(userName);

            useEffect(() => {
                setEditName(userName);
            }, [userName, isOpen]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden">
                        <div className="bg-gray-800 text-white p-3 font-bold text-center">
                            ユーザー編集
                        </div>
                        <div className="p-6">
                            <div className="mb-4">
                                <label className="block text-sm font-bold text-gray-700 mb-2">ユーザー名</label>
                                <input 
                                    type="text" 
                                    value={editName}
                                    onChange={(e) => setEditName(e.target.value)}
                                    className="border rounded w-full p-2 text-lg"
                                />
                            </div>
                            <button 
                                onClick={() => onRename(editName)}
                                className="w-full bg-blue-600 text-white font-bold py-2 rounded shadow hover:bg-blue-700 mb-6"
                            >
                                名前を変更して保存
                            </button>

                            <div className="border-t pt-4">
                                <p className="text-xs text-red-500 mb-2 text-center">※削除するとデータは復元できません</p>
                                <button 
                                    onClick={onDelete}
                                    className="w-full bg-red-100 text-red-600 font-bold py-2 rounded hover:bg-red-200 border border-red-200"
                                >
                                    このユーザーを削除
                                </button>
                            </div>
                        </div>
                        <div className="bg-gray-50 p-3 text-center border-t">
                            <button onClick={onClose} className="text-gray-600 font-bold px-6 py-2 rounded hover:bg-gray-200">キャンセル</button>
                        </div>
                    </div>
                </div>
            );
        };

        // 休暇・変更メニューモーダル
        const LeaveControlModal = ({ isOpen, onClose, onApply, isHolidayOrOff }) => {
            if (!isOpen) return null;
            const [hourlyStart, setHourlyStart] = useState('09:00');
            const [hourlyEnd, setHourlyEnd] = useState('10:00');

            const calculateHourlyLeave = () => {
                if (!hourlyStart || !hourlyEnd) return { mins: 0, hours: 0 };
                const startM = timeToMinutes(hourlyStart);
                const endM = timeToMinutes(hourlyEnd);
                let diff = endM - startM;
                if (diff <= 0) diff = 0;
                const hoursDeducted = Math.ceil(diff / 60);
                return { mins: diff, hours: hoursDeducted };
            };
            const leaveStats = calculateHourlyLeave();

            return (
                <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white rounded-lg shadow-xl w-full max-w-sm overflow-hidden flex flex-col max-h-[90vh]">
                        <div className={`text-white p-3 font-bold text-center flex-shrink-0 ${isHolidayOrOff ? 'bg-orange-600' : 'bg-blue-600'}`}>
                            {isHolidayOrOff ? '休日出勤 登録' : '休暇・勤務変更'}
                        </div>
                        <div className="p-4 overflow-y-auto">
                            
                            {/* 休日出勤メニュー (休日のみ表示) */}
                            {isHolidayOrOff && (
                                <div className="mb-4 border-b pb-4">
                                    <div className="text-sm font-bold text-gray-700 mb-2 flex items-center">
                                        <span className="bg-orange-100 text-orange-800 text-xs px-2 py-0.5 rounded mr-2">休日出勤</span>
                                        振替休日が発生します
                                    </div>
                                    <div className="grid grid-cols-1 gap-2">
                                        <button onClick={() => onApply('work_holiday_full')} className="bg-orange-50 hover:bg-orange-100 text-orange-800 py-2 rounded border border-orange-200 text-sm">
                                            <strong>丸1日 勤務</strong> (+1.0日 振替)<br/><span className="text-xs">8:30 - 17:15</span>
                                        </button>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => onApply('work_holiday_am')} className="bg-orange-50 hover:bg-orange-100 text-orange-800 py-2 rounded border border-orange-200 text-sm">
                                                <strong>午前 勤務</strong> (+0.5日)<br/><span className="text-xs">8:30 - 12:30 (4h)</span>
                                            </button>
                                            <button onClick={() => onApply('work_holiday_pm')} className="bg-orange-50 hover:bg-orange-100 text-orange-800 py-2 rounded border border-orange-200 text-sm">
                                                <strong>午後 勤務</strong> (+0.5日)<br/><span className="text-xs">13:30 - 17:30 (4h)</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* 通常休暇メニュー (平日のみ表示) */}
                            {!isHolidayOrOff && (
                                <>
                                    {/* 振替休日消化 */}
                                    <div className="mb-4 border-b pb-4">
                                        <div className="text-sm font-bold text-gray-700 mb-2 flex items-center">
                                            <span className="bg-green-100 text-green-800 text-xs px-2 py-0.5 rounded mr-2">振替休日</span>
                                            休日出勤の代休
                                        </div>
                                        <div className="grid grid-cols-1 gap-2">
                                            <button onClick={() => onApply('substitute_full')} className="bg-green-50 hover:bg-green-100 text-green-800 py-2 rounded border border-green-200 text-sm">
                                                <strong>全日 振替</strong> (-1.0日)
                                            </button>
                                            <div className="grid grid-cols-2 gap-2">
                                                <button onClick={() => onApply('substitute_am')} className="bg-green-50 hover:bg-green-100 text-green-800 py-2 rounded border border-green-200 text-sm">
                                                    <strong>午前 振替</strong> (-0.5日)<br/><span className="text-xs">13:30 出勤</span>
                                                </button>
                                                <button onClick={() => onApply('substitute_pm')} className="bg-green-50 hover:bg-green-100 text-green-800 py-2 rounded border border-green-200 text-sm">
                                                    <strong>午後 振替</strong> (-0.5日)<br/><span className="text-xs">12:15 退勤</span>
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mb-4 border-b pb-4">
                                        <div className="text-sm font-bold text-gray-700 mb-2 flex items-center">
                                            <span className="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded mr-2">年休(半日)</span>
                                            有給休暇
                                        </div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => onApply('am_leave')} className="bg-blue-50 hover:bg-blue-100 text-blue-800 py-2 rounded border border-blue-200 text-sm">
                                                <strong>午前半休</strong><br/><span className="text-xs">13:30 出勤</span>
                                            </button>
                                            <button onClick={() => onApply('pm_leave')} className="bg-blue-50 hover:bg-blue-100 text-blue-800 py-2 rounded border border-blue-200 text-sm">
                                                <strong>午後半休</strong><br/><span className="text-xs">12:15 退勤</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div className="mb-4 border-b pb-4">
                                        <div className="text-sm font-bold text-gray-700 mb-2 flex items-center">
                                            <span className="bg-purple-100 text-purple-800 text-xs px-2 py-0.5 rounded mr-2">年休(時間)</span>
                                            15分単位入力
                                        </div>
                                        <div className="bg-gray-50 p-3 rounded border mb-2">
                                            <div className="flex items-center justify-center gap-2 mb-2">
                                                <TimeSelect value={hourlyStart} onChange={(e) => setHourlyStart(e.target.value)} options={LEAVE_TIME_OPTIONS} className="border rounded bg-white p-1 w-24 text-center" />
                                                <span>～</span>
                                                <TimeSelect value={hourlyEnd} onChange={(e) => setHourlyEnd(e.target.value)} options={LEAVE_TIME_OPTIONS} className="border rounded bg-white p-1 w-24 text-center" />
                                            </div>
                                            <div className="text-center text-xs text-gray-600">
                                                休: <strong>{leaveStats.mins}分</strong> <span className="text-gray-400">→</span> 消化: <strong className="text-red-600 text-sm">{leaveStats.hours}h</strong>
                                            </div>
                                        </div>
                                        <button onClick={() => onApply('hourly_leave', { start: hourlyStart, end: hourlyEnd, hours: leaveStats.hours })} disabled={leaveStats.mins <= 0} className={`w-full py-2 rounded font-bold text-sm ${leaveStats.mins > 0 ? 'bg-purple-600 text-white hover:bg-purple-700' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}>
                                            時間休を適用
                                        </button>
                                    </div>
                                    <div>
                                        <div className="text-xs text-gray-500 mb-2">その他</div>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={() => onApply('paid_leave')} className="bg-orange-50 hover:bg-orange-100 text-orange-800 py-2 rounded border border-orange-200 text-xs">全日年休</button>
                                            <button onClick={() => onApply('reset_work')} className="bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded border border-gray-300 text-xs">通常出勤に戻す</button>
                                        </div>
                                    </div>
                                </>
                            )}
                            
                            {/* 休日だがリセットしたい場合 */}
                            {isHolidayOrOff && (
                                <div className="mt-4 pt-4 border-t">
                                    <button onClick={() => onApply('reset_off')} className="w-full bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded border border-gray-300 text-xs">
                                        休日設定に戻す (入力をクリア)
                                    </button>
                                </div>
                            )}
                        </div>
                        <div className="bg-gray-50 p-3 text-center border-t flex-shrink-0">
                            <button onClick={onClose} className="text-gray-600 font-bold px-6 py-2 rounded hover:bg-gray-200 text-sm">キャンセル</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            // --- State ---
            const [db, setDb] = useState({ 
                users: ['会津 太郎'], 
                userSettings: { 
                    '会津 太郎': { 
                        fixedOffDay: 5, 
                        defaultLocation: '集落センター',
                        paidLeaveDays: 10 
                    } 
                }, 
                data: {} 
            });
            
            const [currentUser, setCurrentUser] = useState('会津 太郎');
            const [year, setYear] = useState(2026);
            const [month, setMonth] = useState(1);
            
            const [fixedOffDay, setFixedOffDay] = useState(5);
            const [defaultLocation, setDefaultLocation] = useState('集落センター');
            const [paidLeaveGrantDays, setPaidLeaveGrantDays] = useState(10);
            
            const [currentRecords, setCurrentRecords] = useState({});
            const fileInputRef = useRef(null);
            
            // Modal States
            const [isAddingUser, setIsAddingUser] = useState(false);
            const [newUserName, setNewUserName] = useState('');
            const [isEditingUser, setIsEditingUser] = useState(false);
            const [activeDateForModal, setActiveDateForModal] = useState(null);
            const [isModalDateHoliday, setIsModalDateHoliday] = useState(false);

            // --- Effects ---
            useEffect(() => {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    try {
                        const parsed = JSON.parse(saved);
                        if (parsed.users && Array.isArray(parsed.users)) {
                            if (!parsed.userSettings) parsed.userSettings = {};
                            parsed.users.forEach(u => {
                                if (!parsed.userSettings[u]) parsed.userSettings[u] = {};
                                const settings = parsed.userSettings[u];
                                if (settings.fixedOffDay === undefined) settings.fixedOffDay = 5;
                                if (!settings.defaultLocation) settings.defaultLocation = '集落センター';
                                if (settings.paidLeaveDays === undefined) settings.paidLeaveDays = 10;
                            });
                            setDb(parsed);
                            if (parsed.users.length > 0) setCurrentUser(parsed.users[0]);
                        }
                    } catch (e) {
                        console.error("Data load error", e);
                    }
                }
            }, []);

            useEffect(() => {
                const settings = db.userSettings?.[currentUser];
                if (settings) {
                    setFixedOffDay(settings.fixedOffDay !== undefined ? settings.fixedOffDay : 5);
                    setDefaultLocation(settings.defaultLocation || '集落センター');
                    setPaidLeaveGrantDays(settings.paidLeaveDays !== undefined ? settings.paidLeaveDays : 10);
                }
            }, [currentUser, db.userSettings]);

            useEffect(() => {
                const daysInMonth = new Date(year, month, 0).getDate();
                const existingUserData = db.data[currentUser] || {};
                const newRecords = {};
                const userDefaultLoc = db.userSettings?.[currentUser]?.defaultLocation || '集落センター';

                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    if (existingUserData[dateStr]) {
                        newRecords[dateStr] = existingUserData[dateStr];
                    } else {
                        const dateObj = new Date(year, month - 1, d);
                        const dayOfWeek = dateObj.getDay();
                        
                        let status = 'work';
                        let start = '08:30';
                        let end = '17:15';
                        let breakTime = '60';

                        // 休日判定ロジック更新 (年末年始 12/29-1/3 を含む)
                        const isYearEnd = (month === 12 && d >= 29);
                        const isNewYear = (month === 1 && d <= 3);

                        if (dayOfWeek === 0 || dayOfWeek === 6) {
                            status = 'off_assigned';
                            start = ''; end = ''; breakTime = '';
                        } else if (dayOfWeek === fixedOffDay) {
                            status = 'off_assigned';
                            start = ''; end = ''; breakTime = '';
                        } else if (HOLIDAYS_DATA[dateStr] || isYearEnd || isNewYear) {
                            status = 'holiday';
                            start = ''; end = ''; breakTime = '';
                        }

                        newRecords[dateStr] = {
                            status,
                            start,
                            end,
                            breakTime,
                            content: '',
                            location: userDefaultLoc,
                            remarks: HOLIDAYS_DATA[dateStr] || (isYearEnd || isNewYear ? '年末年始休日' : '')
                        };
                    }
                }
                setCurrentRecords(newRecords);
            }, [year, month, currentUser, fixedOffDay, defaultLocation, db.users]);

            // --- Logic ---
            const saveData = (updatedRecords) => {
                const newDb = { ...db, data: { ...db.data, [currentUser]: { ...(db.data[currentUser] || {}), ...updatedRecords } } };
                setDb(newDb);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(newDb));
            };

            const updateUserSettings = (newSettings) => {
                const newDb = { ...db, userSettings: { ...db.userSettings, [currentUser]: { ...(db.userSettings?.[currentUser] || {}), ...newSettings } } };
                setDb(newDb);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(newDb));
            };

            const handleRecordChange = (dateStr, field, value) => {
                const updatedRecords = { ...currentRecords };
                const currentRecord = { ...updatedRecords[dateStr] };
                currentRecord[field] = value;
                if (field === 'status') {
                    if (value === 'work') {
                        currentRecord.start = '08:30'; currentRecord.end = '17:15'; currentRecord.breakTime = '60';
                        if (!currentRecord.location) currentRecord.location = defaultLocation;
                    } else {
                        currentRecord.start = ''; currentRecord.end = ''; currentRecord.breakTime = '';
                    }
                }
                updatedRecords[dateStr] = currentRecord;
                setCurrentRecords(updatedRecords);
                saveData(updatedRecords);
            };

            const openLeaveModal = (dateStr, dayOfWeek) => {
                // 年末年始判定も加える
                const d = new Date(dateStr).getDate();
                const m = new Date(dateStr).getMonth() + 1;
                const isYearEnd = (m === 12 && d >= 29);
                const isNewYear = (m === 1 && d <= 3);
                
                const isHoliday = dayOfWeek === 0 || dayOfWeek === 6 || dayOfWeek === fixedOffDay || !!HOLIDAYS_DATA[dateStr] || isYearEnd || isNewYear;
                setIsModalDateHoliday(isHoliday);
                setActiveDateForModal(dateStr);
            };

            const applyLeaveOption = (type, payload) => {
                const dateStr = activeDateForModal;
                if (!dateStr) return;
                const updatedRecords = { ...currentRecords };
                const r = { ...updatedRecords[dateStr] };
                
                if (!['paid_leave', 'substitute_full', 'off_assigned', 'holiday'].includes(type)) {
                    r.status = 'work'; r.breakTime = '60';
                    if (!r.location) r.location = defaultLocation;
                }

                switch (type) {
                    case 'am_leave': r.start = '13:30'; r.end = '17:15'; r.remarks = '年休(半日)'; break;
                    case 'pm_leave': r.start = '08:30'; r.end = '12:15'; r.remarks = '年休(半日)'; break;
                    case 'hourly_leave':
                        if (payload && payload.start && payload.end) {
                            const note = `時間休${payload.hours}h(${payload.start}-${payload.end})`;
                            r.remarks = r.remarks ? `${r.remarks} ${note}` : note;
                        }
                        break;
                    case 'paid_leave': r.status = 'paid_leave'; r.start = ''; r.end = ''; r.remarks = ''; break;
                    case 'reset_work': r.status = 'work'; r.start = '08:30'; r.end = '17:15'; r.remarks = ''; break;
                    case 'substitute_full': r.status = 'substitute'; r.start = ''; r.end = ''; r.remarks = '振替休日'; break;
                    case 'substitute_am': r.status = 'work'; r.start = '13:30'; r.end = '17:15'; r.remarks = '振替休日(午前)'; break;
                    case 'substitute_pm': r.status = 'work'; r.start = '08:30'; r.end = '12:15'; r.remarks = '振替休日(午後)'; break;
                    case 'work_holiday_full': r.status = 'work'; r.start = '08:30'; r.end = '17:15'; r.remarks = '休日出勤(全日)'; break;
                    case 'work_holiday_am': r.status = 'work'; r.start = '08:30'; r.end = '12:30'; r.breakTime = '0'; r.remarks = '休日出勤(午前)'; break;
                    case 'work_holiday_pm': r.status = 'work'; r.start = '13:30'; r.end = '17:30'; r.breakTime = '0'; r.remarks = '休日出勤(午後)'; break;
                    case 'reset_off':
                        const dateObj = new Date(dateStr);
                        const dayOfWeek = dateObj.getDay();
                        const d = dateObj.getDate();
                        const m = dateObj.getMonth() + 1;
                        const isYearEnd = (m === 12 && d >= 29);
                        const isNewYear = (m === 1 && d <= 3);

                        if (dayOfWeek === 0 || dayOfWeek === 6 || dayOfWeek === fixedOffDay) {
                            r.status = 'off_assigned';
                        } else if (HOLIDAYS_DATA[dateStr] || isYearEnd || isNewYear) {
                            r.status = 'holiday';
                        }
                        r.start = ''; r.end = ''; 
                        r.remarks = HOLIDAYS_DATA[dateStr] || (isYearEnd || isNewYear ? '年末年始休日' : '');
                        break;
                }
                updatedRecords[dateStr] = r;
                setCurrentRecords(updatedRecords);
                saveData(updatedRecords);
                setActiveDateForModal(null);
            };

            const handleRenameUser = (newName) => {
                if (!newName || newName === currentUser) { setIsEditingUser(false); return; }
                if (db.users.includes(newName)) { alert('その名前は既に使用されています。'); return; }
                const newDb = { ...db };
                newDb.users = newDb.users.map(u => u === currentUser ? newName : u);
                if (newDb.userSettings[currentUser]) {
                    newDb.userSettings[newName] = newDb.userSettings[currentUser];
                    delete newDb.userSettings[currentUser];
                }
                if (newDb.data[currentUser]) {
                    newDb.data[newName] = newDb.data[currentUser];
                    delete newDb.data[currentUser];
                }
                setDb(newDb);
                setCurrentUser(newName);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(newDb));
                setIsEditingUser(false);
            };

            const executeDeleteUser = () => {
                if(!confirm(`本当に「${currentUser}」を削除しますか？\nこの操作は取り消せません。`)) return;
                const newUsers = db.users.filter(u => u !== currentUser);
                const newData = { ...db.data };
                delete newData[currentUser];
                const newSettings = { ...db.userSettings };
                delete newSettings[currentUser];
                const newDb = { users: newUsers, data: newData, userSettings: newSettings };
                setDb(newDb);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(newDb));
                if (newUsers.length > 0) {
                    setCurrentUser(newUsers[0]);
                } else {
                    const defaultName = '新規ユーザー';
                    setDb({ users: [defaultName], userSettings: { [defaultName]: { fixedOffDay: 5, defaultLocation: '集落センター', paidLeaveDays: 10 } }, data: {} });
                    setCurrentUser(defaultName);
                }
                setIsEditingUser(false);
            };

            const calculateOvertime = (record) => {
                if (record.status !== 'work' && record.status !== 'substitute') return '';
                if (!record.start || !record.end) return '';
                const startM = timeToMinutes(record.start);
                const endM = timeToMinutes(record.end);
                const breakM = parseInt(record.breakTime || 0);
                const workM = endM - startM - breakM;
                const standardM = 465; 
                const overtimeM = workM - standardM;
                return overtimeM > 0 ? minutesToTime(overtimeM) : '';
            };

            const handleBackup = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(db));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                downloadAnchorNode.setAttribute("download", `勤務実績バックアップ_${date}.json`);
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const handleRestoreTrigger = () => {
                if (fileInputRef.current) {
                    fileInputRef.current.click();
                }
            };

            const handleRestoreFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const json = JSON.parse(event.target.result);
                        if (json && json.users && Array.isArray(json.users)) {
                            if (confirm("現在のデータを上書きして復元しますか？\n(現在のデータは失われます)")) {
                                setDb(json);
                                localStorage.setItem(STORAGE_KEY, JSON.stringify(json));
                                if (json.users.includes(currentUser)) {
                                } else if (json.users.length > 0) {
                                    setCurrentUser(json.users[0]);
                                }
                                alert("データを復元しました。");
                            }
                        } else {
                            alert("無効なファイル形式です。");
                        }
                    } catch (error) {
                        console.error(error);
                        alert("ファイルの読み込みに失敗しました。");
                    }
                    e.target.value = '';
                };
                reader.readAsText(file);
            };

            const handlePrint = () => { try { window.print(); } catch (e) { alert("Ctrl + P (Command + P) で印刷してください。"); } };

            const exportToExcel = () => {
                const daysInMonth = new Date(year, month, 0).getDate();
                const data = [];
                data.push(['日付', '曜日', '業務内容', '勤務場所', '出勤', '退勤', '時間外', '備考', 'ステータス']);
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                    const r = currentRecords[dateStr] || {};
                    const dateObj = new Date(year, month - 1, d);
                    const weekDay = WEEKDAYS[dateObj.getDay()];
                    let displayRemarks = r.remarks || '';
                    if(r.status === 'paid_leave') displayRemarks = "年休 " + displayRemarks;
                    if(r.status === 'substitute') displayRemarks = "振替休日 " + displayRemarks;
                    data.push([
                        `${month}/${d}`, weekDay, r.content || '', r.location || '',
                        r.start || '', r.end || '', calculateOvertime(r), displayRemarks,
                        STATUS_OPTIONS.find(o => o.value === r.status)?.label || r.status
                    ]);
                }
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!cols'] = [{ wch: 10 }, { wch: 5 }, { wch: 30 }, { wch: 15 }, { wch: 8 }, { wch: 8 }, { wch: 8 }, { wch: 20 }, { wch: 10 }];
                XLSX.utils.book_append_sheet(wb, ws, `${year}年${month}月`);
                XLSX.writeFile(wb, `勤務実績_${currentUser}_${year}年${month}月.xlsx`);
            };

            const stats = useMemo(() => {
                let workDays = 0;
                let absentDays = 0;
                let usedPaidLeaveHours = 0;
                let subHolidayBalance = 0;
                let totalOvertimeMinutes = 0;

                Object.values(currentRecords).forEach(r => {
                    if (r.status === 'work' || r.status === 'substitute') workDays++;
                    if (r.status === 'absent') absentDays++;
                    
                    if (r.status === 'paid_leave') usedPaidLeaveHours += 8;
                    if (r.remarks) {
                        if (r.remarks.includes('年休(半日)')) usedPaidLeaveHours += 4;
                        const match = r.remarks.match(/時間休(\d+)h/);
                        if (match) usedPaidLeaveHours += parseInt(match[1], 10);
                        
                        if (r.remarks.includes('休日出勤(全日)')) subHolidayBalance += 1.0;
                        if (r.remarks.includes('休日出勤(午前)') || r.remarks.includes('休日出勤(午後)')) subHolidayBalance += 0.5;
                        
                        if (r.remarks.includes('振替休日(午前)') || r.remarks.includes('振替休日(午後)')) subHolidayBalance -= 0.5;
                    }
                    if (r.status === 'substitute') subHolidayBalance -= 1.0;

                    if ((r.status === 'work' || r.status === 'substitute') && r.start && r.end) {
                        const startM = timeToMinutes(r.start);
                        const endM = timeToMinutes(r.end);
                        const breakM = parseInt(r.breakTime || 0);
                        const workM = endM - startM - breakM;
                        const standardM = 465;
                        const overtime = workM - standardM;
                        if (overtime > 0) totalOvertimeMinutes += overtime;
                    }
                });

                const totalGrantHours = paidLeaveGrantDays * 8;
                const remainingHoursTotal = totalGrantHours - usedPaidLeaveHours;
                const remainingDays = Math.floor(remainingHoursTotal / 8);
                const remainingHours = remainingHoursTotal % 8;
                
                const usedDays = Math.floor(usedPaidLeaveHours / 8);
                const usedHours = usedPaidLeaveHours % 8;

                const otHours = Math.floor(totalOvertimeMinutes / 60);
                const otMins = totalOvertimeMinutes % 60;

                return { 
                    workDays, 
                    absentDays, 
                    usedPaidLeaveHours, 
                    usedDays, 
                    usedHours, 
                    remainingDays, 
                    remainingHours, 
                    subHolidayBalance,
                    totalOvertimeMinutes,
                    otHours,
                    otMins
                };
            }, [currentRecords, paidLeaveGrantDays]);

            const daysInMonth = new Date(year, month, 0).getDate();
            const dateList = [];
            for (let d = 1; d <= daysInMonth; d++) {
                dateList.push({
                    d,
                    dateStr: `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`,
                    dayOfWeek: new Date(year, month - 1, d).getDay()
                });
            }

            return (
                <div className="min-h-screen pb-20 md:pb-10">
                    <div className="screen-only">
                        {/* ヘッダー固定解除 (relative md:sticky) */}
                        <div className="bg-white shadow p-3 md:p-4 mb-4 relative md:sticky md:top-0 z-20">
                            <div className="max-w-6xl mx-auto">
                                <div className="flex flex-col md:flex-row gap-3 justify-between items-center mb-3">
                                    <h1 className="text-lg md:text-xl font-bold text-gray-800">勤務実績管理システム</h1>
                                    
                                    <div className="flex flex-wrap gap-2 w-full md:w-auto justify-end">
                                        <button onClick={handleBackup} className="bg-gray-600 text-white font-bold py-1 px-3 rounded text-xs shadow flex items-center gap-1" title="データを保存">
                                            <i className="ph ph-download-simple"></i> 保存
                                        </button>
                                        <button onClick={handleRestoreTrigger} className="bg-gray-600 text-white font-bold py-1 px-3 rounded text-xs shadow flex items-center gap-1" title="データを復元">
                                            <i className="ph ph-upload-simple"></i> 復元
                                        </button>
                                        <input type="file" ref={fileInputRef} onChange={handleRestoreFile} accept=".json" className="hidden" />
                                        <div className="w-px bg-gray-300 mx-1"></div>
                                        <button onClick={exportToExcel} className="bg-green-600 text-white font-bold py-2 px-4 rounded text-sm shadow">Excel</button>
                                        <button onClick={handlePrint} className="bg-blue-600 text-white font-bold py-2 px-4 rounded text-sm shadow">印刷/PDF</button>
                                    </div>
                                </div>
                                
                                <div className="bg-gray-50 p-3 rounded border grid grid-cols-1 md:grid-cols-4 gap-3 mb-2">
                                    <div className="flex items-center gap-2">
                                        <select value={currentUser} onChange={(e) => setCurrentUser(e.target.value)} className="border rounded p-2 flex-grow bg-white">
                                            {db.users.map(u => <option key={u} value={u}>{u}</option>)}
                                        </select>
                                        <button onClick={() => setIsEditingUser(true)} className="bg-white border text-gray-600 p-2 rounded hover:bg-gray-100"><i className="ph ph-pencil-simple text-lg"></i></button>
                                        <button onClick={() => setIsAddingUser(true)} className="bg-gray-200 p-2 rounded text-sm text-center min-w-[2rem]">＋</button>
                                    </div>
                                    <div className="flex items-center gap-2 justify-center">
                                        <input type="number" value={year} onChange={(e) => setYear(Number(e.target.value))} className="border rounded p-2 w-20 text-center" />
                                        <span>年</span>
                                        <select value={month} onChange={(e) => setMonth(Number(e.target.value))} className="border rounded p-2 w-16 bg-white">
                                            {[...Array(12)].map((_, i) => <option key={i+1} value={i+1}>{i+1}</option>)}
                                        </select>
                                        <span>月</span>
                                    </div>
                                    
                                    <div className="col-span-1 md:col-span-2 flex flex-wrap gap-3 items-center text-xs text-gray-600 justify-end">
                                        <div className="flex items-center gap-1 bg-white px-2 py-1 rounded border">
                                            <span>有給付与:</span>
                                            <input type="number" value={paidLeaveGrantDays} onChange={(e) => {
                                                const val = Number(e.target.value);
                                                setPaidLeaveGrantDays(val); 
                                                updateUserSettings({paidLeaveDays: val});
                                            }} className="border rounded p-1 w-12 text-center" />
                                            <span>日</span>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <span>週休:</span>
                                            <select value={fixedOffDay} onChange={(e) => {setFixedOffDay(Number(e.target.value)); updateUserSettings({fixedOffDay: Number(e.target.value)})}} className="border rounded p-1">
                                                {WEEKDAYS.map((w, i) => i > 0 && i < 6 ? <option key={i} value={i}>{w}</option> : null)}
                                            </select>
                                        </div>
                                        <div className="flex items-center gap-1">
                                            <span>場所:</span>
                                            <input type="text" value={defaultLocation} onChange={(e) => {setDefaultLocation(e.target.value); updateUserSettings({defaultLocation: e.target.value})}} className="border rounded p-1 w-20" />
                                        </div>
                                    </div>
                                </div>

                                {/* 集計ダッシュボード (5列に拡張・振替残追加) */}
                                <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2 mb-2">
                                    <div className="bg-white p-2 rounded shadow-sm border-l-4 border-blue-500">
                                        <div className="text-[10px] text-gray-500">勤務日数</div>
                                        <div className="font-bold text-base">{stats.workDays} <span className="text-xs font-normal">日</span></div>
                                    </div>
                                    <div className="bg-white p-2 rounded shadow-sm border-l-4 border-red-500">
                                        <div className="text-[10px] text-gray-500">時間外合計</div>
                                        <div className="font-bold text-base">{stats.otHours}:{String(stats.otMins).padStart(2, '0')}</div>
                                    </div>
                                    <div className="bg-white p-2 rounded shadow-sm border-l-4 border-orange-500">
                                        <div className="text-[10px] text-gray-500">年休消化</div>
                                        <div className="font-bold text-base">{stats.usedDays} <span className="text-xs font-normal">日</span> {stats.usedHours > 0 ? `${stats.usedHours}h` : ''}</div>
                                    </div>
                                    <div className="bg-white p-2 rounded shadow-sm border-l-4 border-green-500">
                                        <div className="text-[10px] text-gray-500">年休残日数</div>
                                        <div className="font-bold text-base">{stats.remainingDays} <span className="text-xs font-normal">日</span> {stats.remainingHours > 0 ? `${stats.remainingHours}h` : ''}</div>
                                    </div>
                                    {/* 振替休日残パネル */}
                                    <div className={`bg-white p-2 rounded shadow-sm border-l-4 ${stats.subHolidayBalance !== 0 ? 'border-purple-500 bg-purple-50' : 'border-gray-300'}`}>
                                        <div className="text-[10px] text-gray-500">振替休日残</div>
                                        <div className={`font-bold text-base ${stats.subHolidayBalance < 0 ? 'text-red-600' : ''}`}>
                                            {stats.subHolidayBalance} <span className="text-xs font-normal">日分</span>
                                        </div>
                                    </div>
                                </div>

                                {isAddingUser && (
                                    <div className="mt-2 p-2 bg-yellow-50 border rounded flex gap-2">
                                        <input type="text" placeholder="新規ユーザー名" value={newUserName} onChange={(e) => setNewUserName(e.target.value)} className="border p-1 text-sm flex-grow" />
                                        <button onClick={() => {
                                            if(newUserName && !db.users.includes(newUserName)){
                                                const newDb = {...db, users:[...db.users, newUserName], userSettings:{...db.userSettings, [newUserName]: {fixedOffDay:5, defaultLocation:'集落センター', paidLeaveDays: 10}}};
                                                setDb(newDb); setCurrentUser(newUserName); localStorage.setItem(STORAGE_KEY, JSON.stringify(newDb)); setNewUserName(''); setIsAddingUser(false);
                                            }
                                        }} className="bg-blue-500 text-white px-3 rounded text-sm">追加</button>
                                        <button onClick={() => setIsAddingUser(false)} className="text-gray-500 text-sm">✕</button>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* List View */}
                        <div className="max-w-4xl mx-auto px-2">
                            {dateList.map(({ d, dateStr, dayOfWeek }) => {
                                const record = currentRecords[dateStr] || {};
                                const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                const isHoliday = record.status === 'holiday';
                                const colorClass = (dayOfWeek === 0 || isHoliday) ? "text-red-600 bg-red-50" : (dayOfWeek === 6 ? "text-blue-600 bg-blue-50" : "bg-white");
                                const isWorkLike = record.status === 'work' || record.status === 'substitute';

                                return (
                                    <div key={dateStr} className={`mb-3 rounded-lg shadow-sm border overflow-hidden ${colorClass}`}>
                                        <div className="flex items-center justify-between p-2 border-b bg-opacity-50 bg-gray-100">
                                            <div className="flex items-center gap-2">
                                                <span className={`font-bold text-lg w-8 text-center`}>{d}</span>
                                                <span className="text-sm font-bold">({WEEKDAYS[dayOfWeek]})</span>
                                                {record.remarks && <span className="text-xs bg-yellow-200 px-1 rounded truncate max-w-[150px]">{record.remarks}</span>}
                                            </div>
                                            <div className="flex gap-2">
                                                <button onClick={() => openLeaveModal(dateStr, dayOfWeek)} className="text-xs bg-white border border-blue-300 text-blue-600 px-2 py-1 rounded hover:bg-blue-50">
                                                    休暇・変更
                                                </button>
                                            </div>
                                        </div>
                                        <div className="p-3 grid grid-cols-1 md:grid-cols-12 gap-3 items-center">
                                            <div className="md:col-span-4 space-y-2">
                                                <select className="border rounded text-sm p-1 w-full bg-white" value={record.status} onChange={(e) => handleRecordChange(dateStr, 'status', e.target.value)}>
                                                    {STATUS_OPTIONS.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                                </select>
                                                <input type="text" className="border rounded text-sm p-1 w-full" placeholder={isWorkLike ? "業務内容" : ""} value={record.content || ''} onChange={(e) => handleRecordChange(dateStr, 'content', e.target.value)} />
                                            </div>
                                            <div className="md:col-span-5 grid grid-cols-3 gap-2 text-center">
                                                <div><label className="text-[10px] text-gray-500 block">場所</label>{isWorkLike ? <input type="text" className="border-b text-sm w-full text-center" value={record.location || ''} onChange={(e) => handleRecordChange(dateStr, 'location', e.target.value)} placeholder={defaultLocation} /> : <span className="text-gray-300">-</span>}</div>
                                                <div><label className="text-[10px] text-gray-500 block">出勤</label>{isWorkLike ? <TimeSelect value={record.start} onChange={(e) => handleRecordChange(dateStr, 'start', e.target.value)} className="border rounded p-1 text-sm" /> : <span className="text-gray-300">-</span>}</div>
                                                <div><label className="text-[10px] text-gray-500 block">退勤</label>{isWorkLike ? <TimeSelect value={record.end} onChange={(e) => handleRecordChange(dateStr, 'end', e.target.value)} className="border rounded p-1 text-sm" /> : <span className="text-gray-300">-</span>}</div>
                                            </div>
                                            <div className="md:col-span-3 flex md:flex-col gap-2 justify-between md:justify-center">
                                                <div className="text-xs text-center"><span className="md:hidden mr-1">時間外:</span><span className="font-mono">{calculateOvertime(record) || '--:--'}</span></div>
                                                <input type="text" className="border-b text-xs flex-grow md:w-full" placeholder="備考" value={record.remarks || ''} onChange={(e) => handleRecordChange(dateStr, 'remarks', e.target.value)} />
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>

                    <div className="print-only">
                        <div className="print-title">
                            <h2>令和 {year - 2018} 年 {month} 月 勤務実績 ({currentUser})</h2>
                        </div>
                        <table className="print-table">
                            <thead>
                                <tr className="bg-gray-100 text-center">
                                    <th className="w-8">曜<br/>日</th>
                                    <th className="w-8">日</th>
                                    <th>業務内容</th>
                                    <th className="w-24">勤務場所</th>
                                    <th className="w-14">出勤</th>
                                    <th className="w-14">退勤</th>
                                    <th className="w-12">時間外</th>
                                    <th className="w-24">備考</th>
                                </tr>
                            </thead>
                            <tbody>
                                {dateList.map(({ d, dateStr, dayOfWeek }) => {
                                    const record = currentRecords[dateStr] || {};
                                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                                    const isHoliday = record.status === 'holiday';
                                    const isWorkLike = record.status === 'work' || record.status === 'substitute';
                                    let displayRemarks = record.remarks || '';
                                    if(record.status === 'paid_leave' && !displayRemarks.includes('年休')) displayRemarks = "年休 " + displayRemarks;
                                    if(record.status === 'substitute' && !displayRemarks.includes('振替')) displayRemarks = "振替休日 " + displayRemarks;
                                    if(record.status === 'off_assigned') displayRemarks = "週休日";
                                    if(record.status === 'holiday') displayRemarks = "祝日";
                                    return (
                                        <tr key={dateStr}>
                                            <td className={`text-center font-bold ${dayOfWeek === 0 || isHoliday ? 'text-black' : 'text-black'}`}>{WEEKDAYS[dayOfWeek]}</td>
                                            <td className="text-center font-bold">{d}</td>
                                            <td>{record.content}</td>
                                            <td className="text-center">{isWorkLike ? (record.location || defaultLocation) : ''}</td>
                                            <td className="text-center">{isWorkLike ? record.start : ''}</td>
                                            <td className="text-center">{isWorkLike ? record.end : ''}</td>
                                            <td className="text-center">{calculateOvertime(record)}</td>
                                            <td className="text-xs">{displayRemarks}</td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                        <div className="print-footer">
                            <div className="print-footer-box">
                                <div style={{display: 'flex', justifyContent: 'space-between', borderBottom: '1px dashed #000', marginBottom: '1mm'}}>
                                    <span>出勤日数</span><span className="font-bold">{stats.workDays} 日</span>
                                </div>
                                <div style={{display: 'flex', justifyContent: 'space-between', borderBottom: '1px dashed #000', marginBottom: '1mm'}}>
                                    <span>年休使用</span><span className="font-bold">{Math.floor(stats.usedPaidLeaveHours / 8)}日 {stats.usedPaidLeaveHours % 8 > 0 ? ` ${stats.usedPaidLeaveHours % 8}時間` : ''}</span>
                                </div>
                                <div style={{display: 'flex', justifyContent: 'space-between', borderBottom: '1px dashed #000', marginBottom: '1mm'}}>
                                    <span>時間外合計</span><span className="font-bold">{stats.otHours}時間 {String(stats.otMins).padStart(2, '0')}分</span>
                                </div>
                                <div style={{display: 'flex', justifyContent: 'space-between'}}>
                                    <span>欠勤</span><span className="font-bold">{stats.absentDays} 日</span>
                                </div>
                            </div>
                            <div className="print-footer-info">
                                <strong>【年休管理】</strong> 付与: {paidLeaveGrantDays}日 → 残: <strong>{stats.remainingDays}日 {stats.remainingHours}時間</strong><br/>
                                <strong>【振替残】</strong> {stats.subHolidayBalance} 日分<br/>
                                <strong>【勤務条件】</strong> 週4日 / 8:30～17:15 (休60分)
                            </div>
                        </div>
                    </div>

                    <LeaveControlModal 
                        isOpen={!!activeDateForModal} 
                        onClose={() => setActiveDateForModal(null)}
                        onApply={applyLeaveOption}
                        isHolidayOrOff={isModalDateHoliday}
                    />
                    
                    <UserEditModal 
                        isOpen={isEditingUser}
                        onClose={() => setIsEditingUser(false)}
                        userName={currentUser}
                        onRename={handleRenameUser}
                        onDelete={executeDeleteUser}
                    />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
